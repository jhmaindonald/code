<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R Code for ‘A Practical Guide . . .’ - 6&nbsp; Chapter 6: Time series models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ch7.html" rel="next">
<link href="./ch5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch6.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 6: Time series models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R Code for ‘A Practical Guide . . .’</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jhmaindonald/code/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./R-Code-for--A-Practical-Guide-.-.-.-.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./R-Code-for--A-Practical-Guide-.-.-.-.docx">
              <i class="bi bi-bi-file-word pe-1"></i>
            Download Docx
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Chapter 1: Learning from data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 2: Generalizing from models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 3: Multiple linear regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 4: Exploiting the linear model framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chapter 5: Generalized linear models and survival analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch6.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 6: Time series models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 7: Multilevel models, and repeated measures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 8: Tree-based Classification and Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 9: Multivariate data exploration and discrimination</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Appendix A: The R System – A Brief Overview</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section-6.1-time-series-some-basic-ideas" id="toc-section-6.1-time-series-some-basic-ideas" class="nav-link active" data-scroll-target="#section-6.1-time-series-some-basic-ideas">Section 6.1: Time series – some basic ideas</a></li>
  <li><a href="#section-6.2-nonlinear-time-series" id="toc-section-6.2-nonlinear-time-series" class="nav-link" data-scroll-target="#section-6.2-nonlinear-time-series">Section 6.2: Nonlinear time series</a></li>
  <li><a href="#section-6.3-further-reading" id="toc-section-6.3-further-reading" class="nav-link" data-scroll-target="#section-6.3-further-reading">Section 6.3: Further reading</a></li>
  <li><a href="#section-6.4-exercises" id="toc-section-6.4-exercises" class="nav-link" data-scroll-target="#section-6.4-exercises">Section 6.4: Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 6: Time series models</span></h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<div class="cell">
<style type="text/css">
.colbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid orange;
  border-radius: 10px;
}
.center {
  text-align: left;
}
}
</style>
</div>
<section id="packages-required-plus-any-dependencies" class="level5">
<h5 class="anchored" data-anchor-id="packages-required-plus-any-dependencies">Packages required (plus any dependencies)</h5>
<p>DAAG ggsci latticeExtra ggplot2 mice car forecast mgcv tseries</p>
<p>Additionally, knitr and Hmisc are required in order to process the Rmd source file.</p>
</section>
<section id="section-6.1-time-series-some-basic-ideas" class="level3">
<h3 class="anchored" data-anchor-id="section-6.1-time-series-some-basic-ideas">Section 6.1: Time series – some basic ideas</h3>
<section id="subsection-6.1.1-time-series-objects" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.1-time-series-objects">Subsection 6.1.1: Time series objects</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="st">"lakeHuron"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Use `time()` to extract the `time` attribute</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">time</span>(LakeHuron))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1875 1972</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Use `window()` to subset a time series</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LHto1925 <span class="ot">&lt;-</span> <span class="fu">window</span>(LakeHuron, <span class="at">from=</span><span class="dv">1875</span>, <span class="at">to=</span><span class="dv">1925</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>jobs</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "BC"       "Alberta"  "Prairies" "Ontario"  "Quebec"   "Atlantic" "Date"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>allRegions <span class="ot">&lt;-</span> <span class="fu">ts</span>(jobs[, <span class="sc">-</span><span class="dv">7</span>])   <span class="co"># Create multivariate time series</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span>(allRegions)               <span class="co"># Times run from 1 to 24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time Series:
Start = 1 
End = 24 
Frequency = 1 
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>allRegions <span class="ot">&lt;-</span> <span class="fu">ts</span>(jobs[, <span class="sc">-</span><span class="dv">7</span>], <span class="at">start=</span><span class="fu">c</span>(<span class="dv">1995</span>,<span class="dv">1</span>), <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>allRegions[,<span class="st">"BC"</span>]              <span class="co"># Extract jobs data for British Columbia</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
1995 1752 1737 1765 1762 1754 1759 1766 1775 1777 1771 1757 1766
1996 1786 1784 1791 1800 1800 1798 1814 1803 1796 1818 1829 1840</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>jobsBC <span class="ot">&lt;-</span> <span class="fu">ts</span>(jobs[, <span class="st">"BC"</span>], <span class="at">start=</span><span class="fu">c</span>(<span class="dv">1995</span>,<span class="dv">1</span>), <span class="at">frequency=</span><span class="dv">12</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain equivalent of `allRegions[,"BC"]` directly from `jobs` dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-6.1.2-preliminary-graphical-exploration" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.2-preliminary-graphical-exploration">Subsection 6.1.2: Preliminary graphical exploration</h4>
<div class="cell" data-layout-align="center" data-w="5" data-h="1.8" data-ps="10" data-mgp="[2.25,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot depth measurements: ts object LakeHuron (datasets)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(LakeHuron, <span class="at">ylab=</span><span class="st">"depth (in feet)"</span>, <span class="at">xlab =</span> <span class="st">"Time (in years)"</span>, <span class="at">fg=</span><span class="st">"gray"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lag.plot</span>(LakeHuron, <span class="at">lags=</span><span class="dv">3</span>, <span class="at">do.lines=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-6.1.3-the-autocorrelation-and-partial-autocorrelation-function" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.3-the-autocorrelation-and-partial-autocorrelation-function">Subsection 6.1.3: The autocorrelation and partial autocorrelation function</h4>
<div class="cell" data-layout-align="center" data-w="5.5" data-h="1.95" data-lwd="0.5" data-mgp="[2,1,0]" data-tcl="-0.25" data-ps="9" data-left="1" data-bot="1" data-top="2.5">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_2A-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">1.5</span>,<span class="dv">0</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">pty=</span><span class="st">"s"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lag.plot</span>(LakeHuron, <span class="at">set.lags=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="at">do.lines=</span>F, <span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>,<span class="fl">1.5</span>,<span class="fl">1.5</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">fg=</span><span class="st">"gray"</span>, <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="at">cex.lab=</span><span class="fl">1.15</span>, <span class="at">asp=</span><span class="dv">1</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="fl">0.5</span>, <span class="st">"A: Lag plots"</span>, <span class="at">adj=</span><span class="dv">0</span>, <span class="at">cex=</span><span class="fl">0.85</span>, <span class="at">outer=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="5.5" data-h="2.25" data-mgp="[2.25,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_2B-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>col3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"gray80"</span>,<span class="fu">rev</span>(ggsci<span class="sc">::</span><span class="fu">pal_npg</span>()(<span class="dv">2</span>)))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>lag.max <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>offset <span class="ot">&lt;-</span> <span class="fl">0.18</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ci95 <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">length</span>(LakeHuron))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>ar2 <span class="ot">&lt;-</span> <span class="fu">ar</span>(LakeHuron)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>gph.key <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x=</span><span class="fl">0.975</span>, <span class="at">y=</span><span class="fl">0.965</span>, <span class="at">corner=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">columns=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">0.85</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">text=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"Lake Huron data"</span>,<span class="st">"AR1 process"</span>,<span class="st">"AR2 process"</span>)),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lines=</span><span class="fu">list</span>(<span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="fl">1.5</span>,<span class="fl">1.5</span>), <span class="at">col=</span>col3,<span class="at">lend=</span><span class="dv">2</span>),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">padding.text=</span><span class="dv">1</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>parsetBC <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">fontsize=</span><span class="fu">list</span>(<span class="at">text=</span><span class="dv">8</span>, <span class="at">points=</span><span class="dv">5</span>), </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">superpose.line=</span><span class="fu">list</span>(<span class="at">col=</span>col3, <span class="at">lty=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="fl">1.5</span>,<span class="fl">1.5</span>)))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>parsetBC <span class="ot">&lt;-</span> <span class="fu">modifyList</span>(parsetBC,<span class="fu">list</span>(<span class="at">grid.pars =</span> <span class="fu">list</span>(<span class="at">lineend =</span> <span class="st">"butt"</span>)))</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>lev3 <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"acfData"</span>,<span class="st">"acfAR1"</span>,<span class="st">"acfAR2"</span>),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"acfData"</span>,<span class="st">"acfAR1"</span>,<span class="st">"acfAR2"</span>))</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>acfData <span class="ot">&lt;-</span> <span class="fu">acf</span>(LakeHuron, <span class="at">main=</span><span class="st">""</span>, <span class="at">plot=</span><span class="cn">FALSE</span>, <span class="at">lag.max=</span>lag.max)<span class="sc">$</span>acf</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>pacfData <span class="ot">&lt;-</span> <span class="fu">pacf</span>(LakeHuron, <span class="at">main=</span><span class="st">""</span>, <span class="at">plot=</span><span class="cn">FALSE</span>, <span class="at">lag.max=</span>lag.max)<span class="sc">$</span>acf</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>acfAR1 <span class="ot">&lt;-</span> <span class="fu">ARMAacf</span>(<span class="at">ar=</span><span class="fl">0.8</span>, <span class="at">lag.max=</span>lag.max)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>acfAR2 <span class="ot">&lt;-</span> <span class="fu">ARMAacf</span>(<span class="at">ar=</span>ar2<span class="sc">$</span>ar, <span class="at">ma=</span><span class="dv">0</span>, <span class="at">lag.max=</span>lag.max)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>pacfAR1 <span class="ot">&lt;-</span> <span class="fu">ARMAacf</span>(<span class="at">ar=</span><span class="fl">0.8</span>, <span class="at">lag.max=</span>lag.max, <span class="at">pacf=</span><span class="cn">TRUE</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>pacfAR2 <span class="ot">&lt;-</span> <span class="fu">ARMAacf</span>(<span class="at">ar=</span>ar2<span class="sc">$</span>ar, <span class="at">ma=</span><span class="dv">0</span>, <span class="at">lag.max=</span>lag.max, <span class="at">pacf=</span><span class="cn">TRUE</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>xy <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">acf=</span><span class="fu">c</span>(acfData,acfAR1,acfAR2),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="at">Lag=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>lag.max,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span>offset,offset),</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="fu">rep</span>(lag.max<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>)),</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="at">gp=</span><span class="fu">rep</span>(lev3, <span class="fu">rep</span>(lag.max<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>)))</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>gphB <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(acf <span class="sc">~</span> Lag, <span class="at">data =</span> xy, <span class="at">groups=</span>gp, <span class="at">type=</span><span class="fu">c</span>(<span class="st">"h"</span>),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">par.strip.text =</span> <span class="fu">list</span>(<span class="at">cex =</span> <span class="fl">0.85</span>), <span class="at">lend=</span><span class="dv">2</span>,<span class="at">origin=</span><span class="dv">0</span>, </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.325</span>, <span class="fl">1.04</span>),<span class="at">key=</span>gph.key, <span class="at">par.settings=</span>parsetBC, </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel=</span><span class="cf">function</span>(x,y,...){</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">panel.xyplot</span>(x,y,...)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">panel.abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">lwd=</span><span class="fl">0.8</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">panel.abline</span>(<span class="at">h=</span>ci95, <span class="at">lwd=</span><span class="fl">0.8</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">panel.abline</span>(<span class="at">h=</span><span class="sc">-</span>ci95, <span class="at">lwd=</span><span class="fl">0.8</span>, <span class="at">lty=</span><span class="dv">2</span>) } )</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>xyp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pacf=</span><span class="fu">c</span>(pacfData,pacfAR1,pacfAR2),</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Lag=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>lag.max,<span class="dv">3</span>))<span class="sc">+</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span>offset,offset),</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rep</span>(lag.max,<span class="dv">3</span>))), <span class="at">gp=</span><span class="fu">rep</span>(lev3, <span class="fu">rep</span>(lag.max,<span class="dv">3</span>)))</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>gphC <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(pacf <span class="sc">~</span> Lag, <span class="at">data =</span> xyp, <span class="at">groups=</span>gp, <span class="at">type=</span><span class="fu">c</span>(<span class="st">"h"</span>),</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>               <span class="at">par.strip.text =</span> <span class="fu">list</span>(<span class="at">cex =</span> <span class="fl">0.85</span>), <span class="at">lend=</span><span class="dv">2</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab =</span> <span class="st">"Partial correlation"</span>, <span class="at">origin=</span><span class="dv">0</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.325</span>, <span class="fl">1.04</span>),</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>               <span class="at">key=</span>gph.key, <span class="at">par.settings=</span>parsetBC, </span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>               <span class="at">panel=</span><span class="cf">function</span>(x,y,...){</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">panel.xyplot</span>(x,y,...)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">panel.abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">lwd=</span><span class="fl">0.8</span>)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">panel.abline</span>(<span class="at">h=</span>ci95, <span class="at">lwd=</span><span class="fl">0.8</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">panel.abline</span>(<span class="at">h=</span><span class="sc">-</span>ci95, <span class="at">lwd=</span><span class="fl">0.8</span>, <span class="at">lty=</span><span class="dv">2</span>) } )</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">update</span>(gphB, <span class="at">scales=</span><span class="fu">list</span>(<span class="at">alternating=</span><span class="cn">FALSE</span>, <span class="at">tck=</span><span class="fl">0.5</span>),</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>             <span class="at">ylab =</span> <span class="st">"Autocorrelation"</span>,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>             <span class="at">main=</span><span class="fu">list</span>(<span class="st">"B: Autocorelation -- Data vs AR processes"</span>, </span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>                       <span class="at">font=</span><span class="dv">1</span>, <span class="at">x=</span><span class="dv">0</span>, <span class="at">y=</span><span class="fl">0.25</span>, <span class="at">just=</span><span class="st">"left"</span>, <span class="at">cex=</span><span class="dv">1</span>)), </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pos=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>))</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">update</span>(gphC, </span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">scales=</span><span class="fu">list</span>(<span class="at">x=</span><span class="fu">list</span>(<span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>)), <span class="at">alternating=</span><span class="cn">FALSE</span>, <span class="at">tck=</span><span class="fl">0.5</span>),</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Partial autocorrelation"</span>,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">main=</span><span class="fu">list</span>(<span class="st">"C: Partial autocorrelation -- Data vs AR processes"</span>, </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>                  <span class="at">font=</span><span class="dv">1</span>, <span class="at">x=</span><span class="dv">0</span>, <span class="at">y=</span><span class="fl">0.25</span>, <span class="at">just=</span><span class="st">"left"</span>, <span class="at">cex=</span><span class="dv">1</span>)),</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">pos=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.9</span>),<span class="at">newpage=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(LakeHuron)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## pacf(LakeHuron) gives the plot of partial autocorrelations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-6.1.4-autoregressive-ar-models" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.4-autoregressive-ar-models">Subsection 6.1.4: Autoregressive (AR) models</h4>
<section id="the-ar1-model" class="level5">
<h5 class="anchored" data-anchor-id="the-ar1-model">The <code>AR(1)</code> model</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Yule-Walker autocorrelation estimate</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>LH.yw <span class="ot">&lt;-</span> <span class="fu">ar</span>(LakeHuron, <span class="at">order.max =</span> <span class="dv">1</span>, <span class="at">method =</span> <span class="st">"yw"</span>)  <span class="co"># autocorrelation estimate</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># order.max = 1 for AR(1) model</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>LH.yw<span class="sc">$</span>ar                  <span class="co"># autocorrelation estimate of alpha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8319112</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Maximum likelihood estimate</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>LH.mle <span class="ot">&lt;-</span> <span class="fu">ar</span>(LakeHuron, <span class="at">order.max =</span> <span class="dv">1</span>, <span class="at">method =</span> <span class="st">"mle"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>LH.mle<span class="sc">$</span>ar                 <span class="co"># maximum likelihood estimate of alpha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.837546</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>LH.mle<span class="sc">$</span>x.mean             <span class="co"># estimated series mean</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 579.1141</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>LH.mle<span class="sc">$</span>var.pred           <span class="co"># estimated innovation variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5092867</code></pre>
</div>
</div>
</section>
<section id="the-general-arp-model" class="level5">
<h5 class="anchored" data-anchor-id="the-general-arp-model">The general AR(p) model</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ar</span>(LakeHuron, <span class="at">method=</span><span class="st">"mle"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
ar(x = LakeHuron, method = "mle")

Coefficients:
      1        2  
 1.0437  -0.2496  

Order selected 2  sigma^2 estimated as  0.4788</code></pre>
</div>
</div>
</section>
<section id="moving-average-ma-processes" class="level5">
<h5 class="anchored" data-anchor-id="moving-average-ma-processes">~Moving average (MA) processes</h5>
<div class="cell" data-layout-align="center" data-w="6" data-h="3.25">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="subsection-6.1.5-autoregressive-moving-average-arma-models-theory" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.5-autoregressive-moving-average-arma-models-theory">Subsection 6.1.5: ~Autoregressive moving average (ARMA) models – theory</h4>
</section>
<section id="subsection-6.1.6-automatic-model-selection" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.6-automatic-model-selection">Subsection 6.1.6: Automatic model selection?</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast, <span class="at">quietly=</span><span class="cn">TRUE</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>(aaLH <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(LakeHuron, <span class="at">approximation=</span>F, <span class="at">stepwise=</span>F))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: LakeHuron 
ARIMA(2,1,1) 

Coefficients:
         ar1      ar2      ma1
      0.9712  -0.2924  -0.9108
s.e.  0.1137   0.1030   0.0712

sigma^2 = 0.5003:  log likelihood = -102.54
AIC=213.07   AICc=213.51   BIC=223.37</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check that model removes most of the correlation structure</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(aaLH, <span class="at">type=</span><span class="st">"innovation"</span>))   <span class="co"># `type="innovation"` is the default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF1_5b-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(LakeHuron)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: LakeHuron 
ARIMA(0,1,0) 

sigma^2 = 0.5588:  log likelihood = -109.11
AIC=220.22   AICc=220.26   BIC=222.79</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(aaLH0 <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(LakeHuron, <span class="at">d=</span><span class="dv">0</span>, <span class="at">approximation=</span>F, <span class="at">stepwise=</span>F))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: LakeHuron 
ARIMA(1,0,1) with non-zero mean 

Coefficients:
         ar1     ma1      mean
      0.7449  0.3206  579.0555
s.e.  0.0777  0.1135    0.3501

sigma^2 = 0.4899:  log likelihood = -103.25
AIC=214.49   AICc=214.92   BIC=224.83</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="4" data-h="2.4" data-mgp="[2,0.5,0]" data-tcl="-0.25" data-ps="10" data-top="2.5">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:48.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_4-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:48.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">forecast</span>(aaLH0,  <span class="at">h=</span><span class="dv">12</span>))  <span class="do">## `level=c(80,95)` is the default</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>fcETS <span class="ot">&lt;-</span> <span class="fu">forecast</span>(LakeHuron, <span class="at">h=</span><span class="dv">12</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fcETS)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">forecast</span>(aaLH,  <span class="at">h=</span><span class="dv">12</span>, <span class="at">level=</span><span class="fu">c</span>(<span class="dv">80</span>,<span class="dv">95</span>)))  <span class="co"># Panel B; ARIMA(2,1,1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF1_5f-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF1_5f-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF1_5f-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(LakeHuron, <span class="at">d=</span><span class="dv">0</span>, <span class="at">max.Q=</span><span class="dv">0</span>, <span class="at">approximation=</span>F, <span class="at">stepwise=</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: LakeHuron 
ARIMA(1,0,1) with non-zero mean 

Coefficients:
         ar1     ma1      mean
      0.7449  0.3206  579.0555
s.e.  0.0777  0.1135    0.3501

sigma^2 = 0.4899:  log likelihood = -103.25
AIC=214.49   AICc=214.92   BIC=224.83</code></pre>
</div>
</div>
<section id="use-of-simulation-as-a-check" class="level5">
<h5 class="anchored" data-anchor-id="use-of-simulation-as-a-check">Use of simulation as a check</h5>
<div class="cell" data-layout-align="center" data-w="4.25" data-h="2.1">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="fl">3.1</span>,<span class="fl">4.6</span>,<span class="fl">2.6</span>, <span class="fl">1.1</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  simts <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="at">model=</span><span class="fu">list</span>(<span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>), <span class="at">ma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.25</span><span class="sc">*</span>i)), <span class="at">n=</span><span class="dv">98</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(simts, <span class="at">main=</span><span class="st">""</span>, <span class="at">xlab=</span><span class="st">""</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="fl">0.5</span>, <span class="fu">paste</span>(<span class="st">"ma3 ="</span>, <span class="fl">0.25</span><span class="sc">*</span>i), <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF1_6c-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">29</span>)         <span class="co"># Ensure that results are reproducible</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>estMAord <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">4</span>, <span class="at">ncol=</span><span class="dv">20</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>){</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    simts <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="at">n=</span><span class="dv">98</span>, <span class="at">model=</span><span class="fu">list</span>(<span class="at">ma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.125</span><span class="sc">*</span>i)))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    estMAord[i,j] <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(simts, <span class="at">start.q=</span><span class="dv">3</span>)<span class="sc">$</span>arma[<span class="dv">2</span>] }</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>detectedAs <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">row</span>(estMAord), estMAord)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(detectedAs) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ma3=</span><span class="fu">paste</span>(<span class="fl">0.125</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="at">Order=</span><span class="fu">paste</span>(<span class="dv">0</span><span class="sc">:</span>(<span class="fu">dim</span>(detectedAs)[<span class="dv">2</span>]<span class="sc">-</span><span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(detectedAs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Order
ma3      0  1  2  3  4
  0.125 18  2  0  0  0
  0.25  11  3  0  6  0
  0.375  7  2  2  7  2
  0.5    1  1  0 13  5</code></pre>
</div>
</div>
</section>
</section>
<section id="subsection-6.1.7-seasonal-effects" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.7-seasonal-effects">Subsection 6.1.7: Seasonal effects</h4>
<div class="cell" data-layout-align="center" data-w="4" data-h="2.4" data-bot="1" data-left="-1" data-top="2" data-ps="9" data-mgp="[1.75,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:48.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_6-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:48.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(ggplot2))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>mdb12AVt1980on <span class="ot">&lt;-</span> <span class="fu">window</span>(DAAG<span class="sc">::</span>mdbAVtJtoD, <span class="fu">c</span>(<span class="dv">1980</span>,<span class="dv">1</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>AVt.ets <span class="ot">&lt;-</span> <span class="fu">ets</span>(mdb12AVt1980on)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(AVt.ets, <span class="at">main=</span><span class="st">""</span>, <span class="at">fg=</span><span class="st">"gray"</span>) <span class="sc">+</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"A: Components of ETS fit"</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>, <span class="at">vjust=</span><span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">11</span>))</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">monthplot</span>(mdb12AVt1980on, <span class="at">col.base=</span><span class="dv">2</span>,  <span class="at">fg=</span><span class="st">"gray"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"B: Seasonal component, SI ratio"</span>, </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">font.main=</span><span class="dv">1</span>, <span class="at">line=</span><span class="dv">1</span>, <span class="at">adj=</span><span class="dv">0</span>, <span class="at">cex=</span><span class="fl">1.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="7.5" data-h="2.25" data-ps="9" data-las="0">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>bomreg <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>bomregions2021</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot time series mdbRain, SOI, and IOD: ts object bomregions2021 (DAAG)</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>gph <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(<span class="fu">ts</span>(bomreg[, <span class="fu">c</span>(<span class="st">"mdbRain"</span>, <span class="st">"mdbAVt"</span>, <span class="st">"SOI"</span>, <span class="st">"IOD"</span>)], <span class="at">start=</span><span class="dv">1900</span>), </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">xlab=</span><span class="st">""</span>, <span class="at">type=</span><span class="fu">c</span>(<span class="st">'p'</span>,<span class="st">'smooth'</span>), <span class="at">scales=</span><span class="fu">list</span>(<span class="at">alternating=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">3</span>)))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(gph, <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="at">par.settings=</span>DAAG<span class="sc">::</span><span class="fu">DAAGtheme</span>(<span class="at">color=</span>F))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(mgcv))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>bomreg <span class="ot">&lt;-</span> <span class="fu">within</span>(DAAG<span class="sc">::</span>bomregions2021, mdbrtRain <span class="ot">&lt;-</span> mdbRain<span class="sc">^</span><span class="fl">0.5</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Check first for a sequential correlation structure, after</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="do">## fitting smooth terms s(CO2), s(SOI), and s(IOD)</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>mdbrtRain.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(mdbrtRain<span class="sc">~</span><span class="fu">s</span>(CO2) <span class="sc">+</span> <span class="fu">s</span>(SOI) <span class="sc">+</span> <span class="fu">s</span>(IOD), <span class="at">data=</span>bomreg)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(<span class="fu">resid</span>(mdbrtRain.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: resid(mdbrtRain.gam) 
ARIMA(0,0,0) with zero mean 

sigma^2 = 4.424:  log likelihood = -263.82
AIC=529.64   AICc=529.67   BIC=532.44</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="2.75" data-h="2.5" data-bot="0.5" data-left="-1.5" data-top="0.5" data-ps="9" data-cex.lab="0.9" data-mgp="[1.75,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:32.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_8-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:32.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_8-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:32.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mdbrtRain.gam, <span class="at">residuals=</span>T, <span class="at">cex=</span><span class="dv">2</span>, <span class="at">fg=</span><span class="st">"gray"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Do also `gam.check(mdbrtRain.gam)` (Output looks fine)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mdbrtRain.gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
mdbrtRain ~ s(CO2) + s(SOI) + s(IOD)

Approximate significance of smooth terms:
         edf Ref.df      F  p-value
s(CO2) 2.144  2.673  4.345  0.01090
s(SOI) 2.058  2.637 12.581 2.72e-06
s(IOD) 1.000  1.000  9.696  0.00233</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(<span class="fu">resid</span>(mdbrtRain.gam), <span class="at">lag=</span><span class="dv">10</span>, <span class="at">type=</span><span class="st">"Ljung"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  resid(mdbrtRain.gam)
X-squared = 11.935, df = 10, p-value = 0.2894</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Examine normality of estimates of "residuals" </span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">resid</span>(mdbrtRain.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-mdbavt-series" class="level5">
<h5 class="anchored" data-anchor-id="the-mdbavt-series">The mdbAVt series</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>mdbAVt.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(mdbAVt <span class="sc">~</span> <span class="fu">s</span>(CO2)<span class="sc">+</span><span class="fu">s</span>(SOI)<span class="sc">+</span><span class="fu">s</span>(IOD), <span class="at">data=</span>bomreg)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(<span class="fu">resid</span>(mdbAVt.gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: resid(mdbAVt.gam) 
ARIMA(0,0,0) with zero mean 

sigma^2 = 0.1689:  log likelihood = -59.33
AIC=120.67   AICc=120.7   BIC=123.39</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mdbAVt.gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
mdbAVt ~ s(CO2) + s(SOI) + s(IOD)

Approximate significance of smooth terms:
         edf Ref.df      F p-value
s(CO2) 1.855  2.312 41.842 &lt; 2e-16
s(SOI) 1.000  1.000 10.688 0.00145
s(IOD) 1.000  1.000  0.005 0.94403</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>mdbAVt1.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(mdbAVt <span class="sc">~</span> <span class="fu">s</span>(CO2)<span class="sc">+</span><span class="fu">s</span>(SOI), <span class="at">data=</span>bomreg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mdbAVt1.gam, <span class="at">residuals=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="6.5" data-h="2.65" data-bot="0.5" data-left="-1.5" data-top="0.5" data-cex.lab="0.9" data-ps="9" data-mgp="[2,0.5,0]" data-mfrow="[1,2]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="6" data-h="2.5" data-bot="0.5" data-left="-1" data-top="0.5" data-cex.lab="0.9" data-mgp="[1.75,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>faclevs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A: Rainfall"</span>, <span class="fu">expression</span>(<span class="st">"B: Average Temp ("</span><span class="sc">^</span>o<span class="sc">*</span><span class="st">"C)"</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fitrain <span class="ot">&lt;-</span> <span class="fu">fitted</span>(mdbrtRain.gam) </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>fitAVt <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">10</span>), <span class="fu">fitted</span>(mdbAVt1.gam))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>gph <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(mdbrtRain<span class="sc">+</span>mdbAVt<span class="sc">~</span>Year,<span class="at">data=</span>bomreg, <span class="at">outer=</span>T, <span class="at">xlab=</span><span class="st">""</span>, <span class="at">ylab=</span><span class="st">""</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">scales=</span><span class="fu">list</span>(<span class="at">y=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">'free'</span>, </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">at=</span><span class="fu">list</span>(<span class="fu">sqrt</span>((<span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>)<span class="sc">*</span><span class="dv">100</span>),(<span class="dv">33</span><span class="sc">:</span><span class="dv">39</span>)<span class="sc">/</span><span class="dv">2</span>), </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">labels=</span><span class="fu">list</span>((<span class="dv">3</span><span class="sc">:</span><span class="dv">8</span>)<span class="sc">*</span><span class="dv">100</span>,(<span class="dv">33</span><span class="sc">:</span><span class="dv">39</span>)<span class="sc">/</span><span class="dv">2</span>)), <span class="at">x=</span><span class="fu">list</span>(<span class="at">alternating=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">2</span>))),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip=</span><span class="fu">strip.custom</span>(<span class="at">factor.levels=</span>faclevs))</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>gph <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">as.layer</span>(<span class="fu">xyplot</span>(fitrain<span class="sc">+</span>fitAVt<span class="sc">~</span>Year, <span class="at">outer=</span>T,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">scales=</span><span class="fu">list</span>(<span class="at">y=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">'free'</span>)), </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data=</span>bomreg, <span class="at">pch=</span><span class="dv">3</span>, <span class="at">col=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Use `auto.arima()` to choose the ARIMA order:</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>aaFitCO2 <span class="ot">&lt;-</span> <span class="fu">with</span>(bomreg[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),], <span class="fu">auto.arima</span>(mdbAVt, <span class="at">xreg=</span><span class="fu">cbind</span>(CO2,SOI)))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Try including a degree 2 polynomial term</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>aaFitpol2CO2 <span class="ot">&lt;-</span> <span class="fu">with</span>(bomreg[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),], </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">auto.arima</span>(mdbAVt, <span class="at">xreg=</span><span class="fu">cbind</span>(<span class="fu">poly</span>(CO2,<span class="dv">2</span>),SOI)))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">AIC</span>(aaFitCO2, aaFitpol2CO2), <span class="at">BIC=</span><span class="fu">BIC</span>(aaFitCO2, aaFitpol2CO2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             df      AIC BIC.df  BIC.BIC
aaFitCO2      7 125.3765      7 144.4060
aaFitpol2CO2  5 129.0109      5 142.6033</code></pre>
</div>
</div>
</section>
</section>
<section id="subsection-6.1.8-the-gamm-function-with-a-correlated-errors-model" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.8-the-gamm-function-with-a-correlated-errors-model">Subsection 6.1.8: The <code>gamm()</code> function, with a correlated errors model</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>SOI.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(SOI<span class="sc">~</span><span class="fu">s</span>(Year), <span class="at">data=</span>bomreg)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(<span class="fu">resid</span>(SOI.gam))             <span class="co"># sigma^2 = 43.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: resid(SOI.gam) 
ARIMA(0,0,2) with zero mean 

Coefficients:
         ma1      ma2
      0.2070  -0.1557
s.e.  0.0943   0.1008

sigma^2 = 43.43:  log likelihood = -402.2
AIC=810.41   AICc=810.61   BIC=818.82</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="do">## The following breaks the model into two parts -- gam and lme</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>SOI.gamm <span class="ot">&lt;-</span> <span class="fu">gamm</span>(SOI<span class="sc">~</span><span class="fu">s</span>(Year), <span class="at">data=</span>bomreg)       </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">resid</span>(SOI.gamm<span class="sc">$</span>lme, <span class="at">type=</span><span class="st">"normalized"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(res)                        <span class="co"># sigma^2 = 0.945</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: res 
ARIMA(0,0,2) with zero mean 

Coefficients:
         ma1      ma2
      0.2070  -0.1557
s.e.  0.0943   0.1008

sigma^2 = 0.9446:  log likelihood = -168.68
AIC=343.37   AICc=343.57   BIC=351.78</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract scale estimate for `gam` component of SOI.gamm</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SOI.gamm<span class="sc">$</span>gam)[[<span class="st">'scale'</span>]]       <span class="co"># 45.98</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45.98091</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that 45.98 x .945 ~= 43.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>SOIma2.gamm <span class="ot">&lt;-</span> <span class="fu">gamm</span>(SOI<span class="sc">~</span><span class="fu">s</span>(Year), <span class="at">data=</span>bomreg, <span class="at">correlation=</span><span class="fu">corARMA</span>(<span class="at">q=</span><span class="dv">2</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(SOIma2.gamm<span class="sc">$</span>lme<span class="sc">$</span>modelStruct<span class="sc">$</span>corStruct, <span class="at">unconstrained =</span> <span class="cn">FALSE</span>)  <span class="co"># MA2 ests</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Theta1     Theta2 
 0.2070115 -0.1557351 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>SOIar2.gamm <span class="ot">&lt;-</span> <span class="fu">gamm</span>(SOI<span class="sc">~</span><span class="fu">s</span>(Year), <span class="at">data=</span>bomreg, <span class="at">correlation=</span><span class="fu">corARMA</span>(<span class="at">p=</span><span class="dv">2</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(SOIar2.gamm<span class="sc">$</span>lme<span class="sc">$</span>modelStruct<span class="sc">$</span>corStruct, <span class="at">unconstrained =</span> <span class="cn">FALSE</span>)  <span class="co"># AR2 ests</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Phi1       Phi2 
 0.2257966 -0.2097561 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">AIC</span>(SOI.gam, SOIma2.gamm<span class="sc">$</span>lme, SOIar2.gamm<span class="sc">$</span>lme), </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">BIC=</span><span class="fu">BIC</span>(SOI.gam, SOIma2.gamm<span class="sc">$</span>lme, SOIar2.gamm<span class="sc">$</span>lme)[,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                df      AIC      BIC
SOI.gam          3 819.2646 827.6767
SOIma2.gamm$lme  6 816.4090 833.2331
SOIar2.gamm$lme  6 815.5117 832.3358</code></pre>
</div>
</div>
<section id="the-dataset-airquality-153-days-new-york-1972" class="level5">
<h5 class="anchored" data-anchor-id="the-dataset-airquality-153-days-new-york-1972">The dataset <code>airquality</code> (153 days, New York, 1972)</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add time in days from May 1 to data. </span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>airq <span class="ot">&lt;-</span> <span class="fu">cbind</span>(airquality[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">day=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(airquality))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column 5 ('day' starting May 1) replaces columns 'Month' &amp; 'Day')</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check numbers of missing values   # Solar.R:7; Ozone:37</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>mice<span class="sc">::</span><span class="fu">md.pattern</span>(airq, <span class="at">plot=</span><span class="cn">FALSE</span>)   <span class="co"># Final row has totals missing.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Wind Temp day Solar.R Ozone   
111    1    1   1       1     1  0
35     1    1   1       1     0  1
5      1    1   1       0     1  1
2      1    1   1       0     0  2
       0    0   0       7    37 44</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="5.5" data-h="5.5">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>smoothPars <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">col.smooth=</span><span class="st">'red'</span>, <span class="at">lty.smooth=</span><span class="dv">2</span>, <span class="at">spread=</span><span class="dv">0</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">spm</span>(airq, <span class="at">cex.labels=</span><span class="fl">1.2</span>, <span class="at">regLine=</span><span class="cn">FALSE</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">1.95</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>), <span class="at">gap=</span>.<span class="dv">15</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">col=</span><span class="fu">adjustcolor</span>(<span class="st">'blue'</span>, <span class="at">alpha.f=</span><span class="fl">0.3</span>), <span class="at">smooth=</span>smoothPars, <span class="at">fg=</span><span class="st">"gray"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">powerTransform</span>(<span class="fu">gam</span>(Ozone <span class="sc">~</span> <span class="fu">s</span>(Solar.R)<span class="sc">+</span><span class="fu">s</span>(Wind)<span class="sc">+</span><span class="fu">s</span>(Temp)<span class="sc">+</span><span class="fu">s</span>(day), <span class="at">data=</span>airq))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated transformation parameter 
       Y1 
0.2306506 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>airq<span class="sc">$</span>rt4Ozone <span class="ot">&lt;-</span> airq<span class="sc">$</span>Ozone<span class="sc">^</span><span class="fl">0.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>Ozone.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(rt4Ozone <span class="sc">~</span> <span class="fu">s</span>(Solar.R)<span class="sc">+</span><span class="fu">s</span>(Wind)<span class="sc">+</span><span class="fu">s</span>(Temp)<span class="sc">+</span><span class="fu">s</span>(day), <span class="at">data=</span>airq)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(<span class="fu">resid</span>(Ozone.gam))  <span class="co"># Independent errors model appears OK</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: resid(Ozone.gam) 
ARIMA(0,0,0) with zero mean 

sigma^2 = 0.05897:  log likelihood = -0.4
AIC=2.79   AICc=2.83   BIC=5.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check model terms</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(Ozone.gam)   <span class="co"># For GAM models, this leaves out terms one at a time</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
rt4Ozone ~ s(Solar.R) + s(Wind) + s(Temp) + s(day)

Approximate significance of smooth terms:
             edf Ref.df      F  p-value
s(Solar.R) 2.284  2.871  7.701 0.000159
s(Wind)    2.448  3.104  9.497 1.29e-05
s(Temp)    4.275  5.287 13.305  &lt; 2e-16
s(day)     1.000  1.000  0.495 0.483507</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="do">## The term in `day` has no explanatory, and will be removed</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>Ozone1.gam <span class="ot">&lt;-</span> <span class="fu">update</span>(Ozone.gam, <span class="at">formula=</span>rt4Ozone <span class="sc">~</span> <span class="fu">s</span>(Solar.R)<span class="sc">+</span><span class="fu">s</span>(Wind)<span class="sc">+</span><span class="fu">s</span>(Temp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="subsection-6.1.9-a-calibration-problem-with-time-series-errors" class="level4">
<h4 class="anchored" data-anchor-id="subsection-6.1.9-a-calibration-problem-with-time-series-errors">Subsection 6.1.9: A calibration problem with time series errors</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>flakes <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>frostedflakes</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>calib.arima <span class="ot">&lt;-</span> <span class="fu">with</span>(flakes, <span class="fu">auto.arima</span>(IA400, <span class="at">xreg=</span>Lab))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>calib.arima</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: IA400 
Regression with ARIMA(0,0,1) errors 

Coefficients:
         ma1  intercept    xreg
      0.3876     6.9235  0.8323
s.e.  0.0859     2.5634  0.0679

sigma^2 = 3.278:  log likelihood = -199.81
AIC=407.62   AICc=408.04   BIC=418.04</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(flakes, <span class="fu">coef</span>(<span class="fu">auto.arima</span>(IA400<span class="sc">/</span>Lab, <span class="at">approximation=</span>F, <span class="at">stepwise=</span>F)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      ma1 intercept 
0.3718151 1.0173303 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(flakes, <span class="fu">coef</span>(<span class="fu">auto.arima</span>(IA400<span class="sc">-</span>Lab, <span class="at">approximation=</span>F, <span class="at">stepwise=</span>F)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      ma1 intercept 
0.3838733 0.6201945 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="6" data-h="2.75" data-bot="0.5" data-top="1.5" data-las="0" data-xpd="true" data-tcl="-0.3" data-cex.lab="0.9" data-ps="10" data-mfrow="[1,2]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g6_12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="section-6.2-nonlinear-time-series" class="level3">
<h3 class="anchored" data-anchor-id="section-6.2-nonlinear-time-series">Section 6.2: Nonlinear time series</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">999</span>)  <span class="co"># x will contain the ARCH(1) errors</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">999</span>){</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">sd=</span><span class="fu">sqrt</span>(.<span class="dv">25</span> <span class="sc">+</span> .<span class="dv">95</span><span class="sc">*</span>x0<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>x[i] <span class="ot">&lt;-</span> x0</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(tseries))</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">garch</span>(x, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">trace=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
garch(x = x, order = c(0, 1), trace = FALSE)

Coefficient(s):
    a0      a1  
0.2804  0.9633  </code></pre>
</div>
</div>
</section>
<section id="section-6.3-further-reading" class="level3">
<h3 class="anchored" data-anchor-id="section-6.3-further-reading">Section 6.3: Further reading</h3>
<section id="spatial-statistics" class="level5">
<h5 class="anchored" data-anchor-id="spatial-statistics">Spatial statistics</h5>
</section>
<section id="other-time-series-models-and-packages" class="level5">
<h5 class="anchored" data-anchor-id="other-time-series-models-and-packages">Other time series models and packages</h5>
</section>
</section>
<section id="section-6.4-exercises" class="level3">
<h3 class="anchored" data-anchor-id="section-6.4-exercises">Section 6.4: Exercises</h3>
<p>6.4</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">matrix</span>(x, <span class="at">ncol=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>6.7</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tseries)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ice.river)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>river1 <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">log</span>(ice.river[, <span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>6.9</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>Eu1 <span class="ot">&lt;-</span> <span class="fu">window</span>(EuStockMarkets[,<span class="dv">1</span>], <span class="at">end =</span> <span class="fu">c</span>(<span class="dv">1996</span>, <span class="dv">260</span>))</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>Eu1nn <span class="ot">&lt;-</span> <span class="fu">nnetar</span>(Eu1)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>Eu1f <span class="ot">&lt;-</span> <span class="fu">forecast</span>(Eu1nn, <span class="at">end=</span><span class="fu">end</span>(EuStockMarkets[,<span class="dv">1</span>]))</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Eu1f, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">1400</span>, <span class="dv">7000</span>))</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(EuStockMarkets[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF7d-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<p>6.10a</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>airq <span class="ot">&lt;-</span> <span class="fu">cbind</span>(airquality[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>], <span class="at">day=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(airquality))</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Column 5 ('day' starting May 1) replaces columns 'Month' &amp; 'Day')</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>temp.gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(Temp<span class="sc">~</span><span class="fu">s</span>(day), <span class="at">data=</span>airq)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>tempAR1.gamm <span class="ot">&lt;-</span> <span class="fu">gamm</span>(Temp<span class="sc">~</span><span class="fu">s</span>(day), <span class="at">data=</span>airq, <span class="at">correlation=</span><span class="fu">corAR1</span>())</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(temp.gam, <span class="at">res=</span>T, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tempAR1.gamm<span class="sc">$</span>gam, <span class="at">res=</span>T, <span class="at">cex=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF7e-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gF7e-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<p>6.10b</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>(Phi <span class="ot">&lt;-</span> <span class="fu">coef</span>(tempAR1.gamm<span class="sc">$</span>lme<span class="sc">$</span>modelStruct<span class="sc">$</span>corStruct, <span class="at">unconstrained =</span> <span class="cn">FALSE</span>) )</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(tempAR1.gamm<span class="sc">$</span>gam<span class="sc">$</span>sig2)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulate an AR1 process with this parameter</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>AR1.sim <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="at">model=</span><span class="fu">list</span>(<span class="at">ar=</span>Phi), <span class="at">n=</span><span class="fu">nrow</span>(airq), <span class="at">sd=</span>Sigma)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>simSeries <span class="ot">&lt;-</span> AR1.sim<span class="sc">+</span><span class="fu">fitted</span>(tempAR1.gamm<span class="sc">$</span>gam)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">I</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(airq)), simSeries)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Compare with initial series</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">I</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(airq)), airq<span class="sc">$</span>Temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="st">"/Users/johnm1/pkgs/PGRcode/inst/doc/"</span>)){</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>code <span class="ot">&lt;-</span> knitr<span class="sc">::</span>knit_code<span class="sc">$</span><span class="fu">get</span>()</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>txt <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">## "</span>, <span class="fu">names</span>(code),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">sapply</span>(code, paste, <span class="at">collapse=</span><span class="st">'</span><span class="sc">\n</span><span class="st">'</span>))</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(txt, <span class="at">con=</span><span class="st">"/Users/johnm1/pkgs/PGRcode/inst/doc/ch6.R"</span>)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./ch5.html" class="pagination-link  aria-label=" &lt;span="" 5:="" generalized="" linear="" models="" and="" survival="" analysis&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chapter 5: Generalized linear models and survival analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch7.html" class="pagination-link" aria-label="<span class='chapter-number'>7</span>&nbsp; <span class='chapter-title'>Chapter 7: Multilevel models, and repeated measures</span>">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 7: Multilevel models, and repeated measures</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>