<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R Code for ‘A Practical Guide . . .’ - 8&nbsp; Chapter 8: Tree-based Classification and Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ch9.html" rel="next">
<link href="./ch7.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch8.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 8: Tree-based Classification and Regression</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R Code for ‘A Practical Guide . . .’</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Chapter 1: Learning from data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Chapter 2: Generalizing from models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Chapter 3: Multiple linear regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Chapter 4: Exploiting the linear model framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chapter 5: Generalized linear models and survival analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Chapter 6: Time series models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 7: Multilevel models, and repeated measures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch8.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 8: Tree-based Classification and Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 9: Multivariate data exploration and discrimination</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Appendix A: The R System – A Brief Overview</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#section-8.1-tree-based-methods-uses-and-basic-notions" id="toc-section-8.1-tree-based-methods-uses-and-basic-notions" class="nav-link active" data-scroll-target="#section-8.1-tree-based-methods-uses-and-basic-notions">Section 8.1: Tree-based methods — uses and basic notions</a></li>
  <li><a href="#section-8.2-splitting-criteria-with-illustrative-examples" id="toc-section-8.2-splitting-criteria-with-illustrative-examples" class="nav-link" data-scroll-target="#section-8.2-splitting-criteria-with-illustrative-examples">Section 8.2: Splitting criteria, with illustrative examples</a></li>
  <li><a href="#section-8.3-the-practicalities-of-tree-construction-two-examples" id="toc-section-8.3-the-practicalities-of-tree-construction-two-examples" class="nav-link" data-scroll-target="#section-8.3-the-practicalities-of-tree-construction-two-examples">Section 8.3: The practicalities of tree construction – two examples</a></li>
  <li><a href="#section-8.4-from-one-tree-to-a-forest-a-more-global-optimality" id="toc-section-8.4-from-one-tree-to-a-forest-a-more-global-optimality" class="nav-link" data-scroll-target="#section-8.4-from-one-tree-to-a-forest-a-more-global-optimality">Section 8.4: From one tree to a forest – a more global optimality</a></li>
  <li><a href="#section-8.5-additional-notes-one-tree-or-many-trees" id="toc-section-8.5-additional-notes-one-tree-or-many-trees" class="nav-link" data-scroll-target="#section-8.5-additional-notes-one-tree-or-many-trees">Section 8.5: Additional notes – one tree, or many trees?</a></li>
  <li><a href="#section-8.6-further-reading-and-extensions" id="toc-section-8.6-further-reading-and-extensions" class="nav-link" data-scroll-target="#section-8.6-further-reading-and-extensions">Section 8.6: Further reading and extensions</a></li>
  <li><a href="#exercises-8.7" id="toc-exercises-8.7" class="nav-link" data-scroll-target="#exercises-8.7">Exercises (8.7)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Chapter 8: Tree-based Classification and Regression</span></h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<div class="cell">
<style type="text/css">
.colbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid orange;
  border-radius: 10px;
}
.center {
  text-align: left;
}
}
</style>
</div>
<section id="packages-required-plus-any-dependencies" class="level5">
<h5 class="anchored" data-anchor-id="packages-required-plus-any-dependencies">Packages required (plus any dependencies)</h5>
<p>DAAG latticeExtra plot rpart rpart.plot MASS ggplot2 car randomForest</p>
<p>Additionally, knitr and Hmisc are required in order to process the Rmd source file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Hmisc<span class="sc">::</span><span class="fu">knitrSet</span>(<span class="at">basename=</span><span class="st">"treebased"</span>, <span class="at">lang=</span><span class="st">'markdown'</span>, <span class="at">fig.path=</span><span class="st">"figs/g"</span>, <span class="at">w=</span><span class="dv">7</span>, <span class="at">h=</span><span class="dv">7</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>oldopt <span class="ot">&lt;-</span> <span class="fu">options</span>(<span class="at">digits=</span><span class="dv">4</span>, <span class="at">formatR.arrow=</span><span class="cn">FALSE</span>, <span class="at">width=</span><span class="dv">70</span>, <span class="at">scipen=</span><span class="dv">999</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## knitr::render_listings()</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>opts_chunk[[<span class="st">'set'</span>]](<span class="at">cache.path=</span><span class="st">'cache-'</span>, <span class="at">out.width=</span><span class="st">"80%"</span>, <span class="at">fig.align=</span><span class="st">"center"</span>, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fig.show=</span><span class="st">'hold'</span>, <span class="at">size=</span><span class="st">"small"</span>, <span class="at">ps=</span><span class="dv">10</span>, <span class="at">strip.white =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">comment=</span><span class="cn">NA</span>, <span class="at">width=</span><span class="dv">70</span>, <span class="at">tidy.opts =</span> <span class="fu">list</span>(<span class="at">replace.assign=</span><span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(latticeExtra))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="when-are-tree-based-methods-appropriate" class="level5">
<h5 class="anchored" data-anchor-id="when-are-tree-based-methods-appropriate">When are tree-based methods appropriate?</h5>
</section>
<section id="section-8.1-tree-based-methods-uses-and-basic-notions" class="level3">
<h3 class="anchored" data-anchor-id="section-8.1-tree-based-methods-uses-and-basic-notions">Section 8.1: Tree-based methods — uses and basic notions</h3>
<section id="examples-that-will-be-used-to-demonstrate-the-methodology" class="level5">
<h5 class="anchored" data-anchor-id="examples-that-will-be-used-to-demonstrate-the-methodology">Examples that will be used to demonstrate the methodology</h5>
</section>
<section id="subsection-8.1.1-detecting-email-spam-an-initial-look" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.1.1-detecting-email-spam-an-initial-look">Subsection 8.1.1: Detecting email spam~– an initial look</h4>
<div class="cell" data-layout-align="center" data-w="8" data-h="4" data-bot="2" data-left="-1" data-las="0" data-mfrow="[2,6]" data-mgp="[1,0.5,0]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_1-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>nam <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"crl.tot"</span>, <span class="st">"dollar"</span>, <span class="st">"bang"</span>, <span class="st">"money"</span>, <span class="st">"n000"</span>, <span class="st">"make"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>nr <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(DAAG<span class="sc">::</span>spam7)[<span class="dv">1</span>],<span class="dv">500</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>yesno<span class="ot">&lt;-</span>DAAG<span class="sc">::</span>spam7<span class="sc">$</span>yesno[nr]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>spam7a <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>spam7[nr,<span class="fu">c</span>(nam,<span class="st">"yesno"</span>)]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>formab <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="fu">paste</span>(nam, <span class="at">collapse=</span><span class="st">'+'</span>), <span class="st">'~ yesno'</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>spamtheme <span class="ot">&lt;-</span> DAAG<span class="sc">::</span><span class="fu">DAAGtheme</span>(<span class="at">color =</span> <span class="cn">TRUE</span>, <span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">bwplot</span>(formab, <span class="at">data=</span>spam7a, <span class="at">outer=</span>T, <span class="at">horizontal=</span>F, <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">1</span>),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">scales=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">'free'</span>), <span class="at">ylab=</span><span class="st">""</span>, <span class="at">par.settings=</span>spamtheme,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">between=</span><span class="fu">list</span>(<span class="at">x=</span><span class="fl">0.5</span>),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">main=</span><span class="fu">list</span>(<span class="st">"A: Raw data values"</span>, <span class="at">y=</span><span class="fl">1.0</span>, <span class="at">font=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">1.25</span>))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>spam7b <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">log</span>(spam7a[,<span class="sc">-</span><span class="dv">7</span>]<span class="sc">+</span><span class="fl">0.001</span>), <span class="at">yesno=</span>spam7a[,<span class="dv">7</span>])</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>yval <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">bwplot</span>(formab, <span class="at">data=</span>spam7b, <span class="at">outer=</span>T, <span class="at">horizontal=</span>F, <span class="at">layout=</span><span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">1</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">scales=</span><span class="fu">list</span>(<span class="at">relation=</span><span class="st">'free'</span>, </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">y=</span><span class="fu">list</span>(<span class="at">at=</span><span class="fu">log</span>(yval<span class="fl">+0.001</span>), <span class="at">labels=</span>yval, <span class="at">rot=</span><span class="dv">90</span>)),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylab=</span><span class="st">""</span>, <span class="at">par.settings=</span>spamtheme, <span class="at">between=</span><span class="fu">list</span>(<span class="at">x=</span><span class="fl">0.5</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="fu">list</span>(<span class="fu">expression</span>(<span class="st">"B: Boxplots, using "</span><span class="sc">*</span><span class="fu">log</span>(x<span class="sc">+</span><span class="dv">001</span>)<span class="sc">*</span><span class="st">" scale"</span>),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">y=</span><span class="fl">1.0</span>, <span class="at">font=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">1.25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Obtain 500-row sample; repeat the first plot (of crl.tot)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spam.sample <span class="ot">&lt;-</span> spam7[<span class="fu">sample</span>(<span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">4601</span>), <span class="dv">500</span>, <span class="at">replace=</span><span class="cn">FALSE</span>), ]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">split</span>(spam.sample<span class="sc">$</span>crl.tot, spam.sample<span class="sc">$</span>yesno))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="4.5" data-h="2.85" data-left="-3">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:65.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(rpart))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">31</span>)      <span class="do">## Reproduce tree shown in text</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>spam.rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> yesno <span class="sc">~</span> crl.tot <span class="sc">+</span> dollar <span class="sc">+</span> bang <span class="sc">+</span> money <span class="sc">+</span> n000 <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                    make,  <span class="at">method=</span><span class="st">"class"</span>, <span class="at">model=</span><span class="cn">TRUE</span>, <span class="at">data=</span>DAAG<span class="sc">::</span>spam7)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(spam.rpart, <span class="at">type=</span><span class="dv">0</span>, <span class="at">under=</span><span class="cn">TRUE</span>, <span class="at">branch.lwd=</span><span class="fl">0.4</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nn.lwd=</span><span class="fl">0.4</span>, <span class="at">box.palette=</span><span class="st">"auto"</span>, <span class="at">tweak=</span><span class="fl">1.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(spam.rpart, <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
rpart(formula = yesno ~ crl.tot + dollar + bang + money + n000 + 
    make, data = DAAG::spam7, method = "class", model = TRUE)

Variables actually used in tree construction:
[1] bang    crl.tot dollar 

Root node error: 1813/4601 = 0.394

n= 4601 

      CP nsplit rel error xerror   xstd
1 0.4766      0     1.000  1.000 0.0183
2 0.0756      1     0.523  0.547 0.0154
3 0.0116      3     0.372  0.388 0.0135
4 0.0105      4     0.361  0.384 0.0134
5 0.0100      5     0.350  0.382 0.0134</code></pre>
</div>
</div>
</section>
<section id="subsection-8.1.2-choosing-the-number-of-splits" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.1.2-choosing-the-number-of-splits">Subsection 8.1.2: Choosing the number of splits</h4>
</section>
</section>
<section id="section-8.2-splitting-criteria-with-illustrative-examples" class="level3">
<h3 class="anchored" data-anchor-id="section-8.2-splitting-criteria-with-illustrative-examples">Section 8.2: Splitting criteria, with illustrative examples</h3>
<div class="cell" data-layout-align="center" data-w="6" data-h="3.75" data-left="-3" data-lwd="0.75">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>tree.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">fac =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">'f1'</span>,<span class="st">'f2'</span>), <span class="dv">3</span>)),</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">3</span>)), <span class="at">Node =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>u.tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Node <span class="sc">~</span> fac <span class="sc">+</span> x, <span class="at">data =</span> tree.df,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">control =</span> <span class="fu">list</span>(<span class="at">minsplit =</span> <span class="dv">2</span>, <span class="at">minbucket =</span> <span class="dv">1</span>, <span class="at">cp =</span> <span class="fl">1e-009</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(u.tree, <span class="at">type=</span><span class="dv">0</span>, <span class="at">under=</span><span class="cn">TRUE</span>, <span class="at">branch.lwd=</span><span class="fl">0.25</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nn.lwd=</span><span class="fl">0.25</span>, <span class="at">box.palette=</span><span class="st">"Grays"</span>, <span class="at">tweak=</span><span class="fl">1.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="choosing-the-split-regression-trees" class="level5">
<h5 class="anchored" data-anchor-id="choosing-the-split-regression-trees">Choosing the split~– regression trees</h5>
</section>
<section id="subsection-8.2.1-within-and-between-sums-of-squares" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.1-within-and-between-sums-of-squares">Subsection 8.2.1: Within and between sums of squares</h4>
</section>
<section id="subsection-8.2.2-choosing-the-split-classification-trees" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.2-choosing-the-split-classification-trees">Subsection 8.2.2: Choosing the split~– classification trees</h4>
</section>
<section id="subsection-8.2.3-tree-based-regression-versus-loess-regression-smoothing" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.3-tree-based-regression-versus-loess-regression-smoothing">Subsection 8.2.3: Tree-based regression versus loess regression smoothing</h4>
<div class="cell" data-layout-align="center" data-w="3" data-h="2.75" data-left="-1" data-mgp="[1.75,0.4,0]" data-lwd="0.75">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>u.lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(Mileage<span class="sc">~</span>Weight, <span class="at">data =</span> car.test.frame, <span class="at">span =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Mileage<span class="sc">~</span>Weight, <span class="at">data=</span>car.test.frame, <span class="at">xlab =</span> <span class="st">"Weight"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Miles per gallon"</span>, <span class="at">sub =</span> <span class="st">""</span>, <span class="at">fg=</span><span class="st">"gray"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>xy <span class="ot">&lt;-</span> <span class="fu">with</span>(car.test.frame, <span class="fu">loess.smooth</span>(Weight, Mileage))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ord<span class="ot">&lt;-</span><span class="fu">order</span>(xy<span class="sc">$</span>x)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(xy<span class="sc">$</span>x[ord],xy<span class="sc">$</span>y[ord])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## loess fit to Mileage vs Weight: data frame car.test.frame (rpart)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(rpart<span class="sc">::</span>car.test.frame, <span class="fu">scatter.smooth</span>(Mileage <span class="sc">~</span> Weight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="4.8" data-h="1.9" data-bot="-1" data-left="-1" data-top="1" data-mgp="[2,0.5,0]" data-lwd="0.75">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">fig=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.32</span>, <span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">37</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>car.tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Mileage <span class="sc">~</span> Weight, <span class="at">data =</span> car.test.frame)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(car.tree, <span class="at">type=</span><span class="dv">0</span>, <span class="at">under=</span><span class="cn">TRUE</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">box.palette=</span><span class="st">"Grays"</span>, <span class="at">tweak=</span><span class="fl">1.05</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">fig=</span><span class="fu">c</span>(<span class="fl">0.3</span>,<span class="dv">1</span>, <span class="dv">0</span>,<span class="dv">1</span>), <span class="at">new=</span><span class="cn">TRUE</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">37</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>car2.tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Mileage<span class="sc">~</span>Weight, <span class="at">data=</span>car.test.frame, <span class="at">control =</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">list</span>(<span class="at">minsplit =</span> <span class="dv">10</span>, <span class="at">minbucket =</span> <span class="dv">5</span>, <span class="at">cp =</span> <span class="fl">0.0001</span>))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(car2.tree, <span class="at">type=</span><span class="dv">0</span>, <span class="at">under=</span><span class="cn">TRUE</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="at">box.palette=</span><span class="st">"auto"</span>, <span class="at">tweak=</span><span class="fl">1.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel A: Split criteria were left a their defaults</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>car.tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Mileage <span class="sc">~</span> Weight, <span class="at">data =</span> car.test.frame)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(car.tree, <span class="at">type=</span><span class="dv">0</span>, <span class="at">under=</span><span class="cn">TRUE</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel B: Finer grained splits</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>car2.tree <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Mileage <span class="sc">~</span> Weight, <span class="at">data=</span>car.test.frame, <span class="at">method=</span><span class="st">"anova"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">control =</span> <span class="fu">list</span>(<span class="at">minsplit =</span> <span class="dv">10</span>, <span class="at">minbucket =</span> <span class="dv">5</span>, <span class="at">cp =</span> <span class="fl">0.0001</span>))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">## See `?rpart::rpart.control` for details of control options.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Weight=</span><span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(car.test.frame<span class="sc">$</span>Weight),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="at">to=</span><span class="fu">max</span>(car.test.frame<span class="sc">$</span>Weight)))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(car.tree, <span class="at">newdata=</span>dat)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(car2.tree, <span class="at">newdata=</span>dat)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>lwr <span class="ot">&lt;-</span> dat<span class="sc">$</span>Weight[<span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">diff</span>(pred)) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>upr <span class="ot">&lt;-</span> dat<span class="sc">$</span>Weight[<span class="fu">c</span>(<span class="fu">diff</span>(pred),<span class="dv">1</span>) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>xy2 <span class="ot">&lt;-</span> <span class="fu">with</span>(car.test.frame, <span class="fu">loess.smooth</span>(Weight, Mileage, <span class="at">evaluation=</span><span class="dv">2011</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>lwrLO <span class="ot">&lt;-</span> xy2<span class="sc">$</span>y[<span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">diff</span>(pred)) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>uprLO <span class="ot">&lt;-</span> xy2<span class="sc">$</span>y[<span class="fu">c</span>(<span class="fu">diff</span>(pred),<span class="dv">1</span>) <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">rbind</span>(lwr,upr,lwrLO,uprLO,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>pred[<span class="fu">c</span>(<span class="fu">diff</span>(pred),<span class="dv">1</span>)<span class="sc">!=</span><span class="dv">0</span>],pred2[<span class="fu">c</span>(<span class="fu">diff</span>(pred),<span class="dv">1</span>)<span class="sc">!=</span><span class="dv">0</span>]),<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         723    903   1243   2011
lwr   1845.0 2568.0 2748.0 3088.0
upr   2567.0 2747.0 3087.0 3855.0
lwrLO   36.2   27.1   25.1   22.3
uprLO   27.1   25.1   22.3   18.8
        30.9   25.6   23.8   20.4
        28.9   25.6   24.1   18.7</code></pre>
</div>
</div>
</section>
<section id="subsection-8.2.4-predictive-accuracy-and-the-cost-complexity-tradeoff" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.4-predictive-accuracy-and-the-cost-complexity-tradeoff">Subsection 8.2.4: Predictive accuracy, and the cost-complexity tradeoff</h4>
</section>
<section id="subsection-8.2.5-cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.5-cross-validation">Subsection 8.2.5: Cross-validation</h4>
</section>
<section id="subsection-8.2.6-the-cost-complexity-parameter" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.6-the-cost-complexity-parameter">Subsection 8.2.6: The cost-complexity parameter</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">"longintro"</span>, <span class="at">package=</span><span class="st">"rpart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-8.2.7-prediction-error-versus-tree-size" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.2.7-prediction-error-versus-tree-size">Subsection 8.2.7: Prediction error versus tree size</h4>
<div class="cell" data-layout-align="center" data-w="6" data-h="2.75" data-left="1" data-top="2.5" data-cex.lab="0.9" data-mfrow="[1,2]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:90.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="section-8.3-the-practicalities-of-tree-construction-two-examples" class="level3">
<h3 class="anchored" data-anchor-id="section-8.3-the-practicalities-of-tree-construction-two-examples">Section 8.3: The practicalities of tree construction – two examples</h3>
<section id="subsection-8.3.1-data-for-female-heart-attack-patients" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.3.1-data-for-female-heart-attack-patients">Subsection 8.3.1: Data for female heart attack patients</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mifem <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>mifem</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mifem)     <span class="co"># data frame mifem (DAAG)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> outcome         age          yronset     premi    smstat   diabetes
 live:974   Min.   :35.0   Min.   :85.0   y :311   c :390   y :248  
 dead:321   1st Qu.:57.0   1st Qu.:87.0   n :928   x :280   n :978  
            Median :63.0   Median :89.0   nk: 56   n :522   nk: 69  
            Mean   :60.9   Mean   :88.8            nk:103           
            3rd Qu.:66.0   3rd Qu.:91.0                             
            Max.   :69.0   Max.   :93.0                             
 highbp   hichol   angina   stroke   
 y :813   y :452   y :472   y : 153  
 n :406   n :655   n :724   n :1063  
 nk: 76   nk:188   nk: 99   nk:  79  
                                     
                                     
                                     </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">29</span>)      <span class="co"># Make results reproducible</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>mifem.rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(outcome <span class="sc">~</span> ., <span class="at">method=</span><span class="st">"class"</span>, <span class="at">data =</span> mifem, <span class="at">cp =</span> <span class="fl">0.0025</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tabular equivalent of Panel A from `plotcp(mifem.rpart)`</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(mifem.rpart, <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
rpart(formula = outcome ~ ., data = mifem, method = "class", 
    cp = 0.0025)

Variables actually used in tree construction:
[1] age      angina   diabetes hichol   premi    smstat   stroke  
[8] yronset 

Root node error: 321/1295 = 0.248

n= 1295 

       CP nsplit rel error xerror   xstd
1 0.20249      0     1.000  1.000 0.0484
2 0.00561      1     0.798  0.829 0.0453
3 0.00467     13     0.717  0.875 0.0462
4 0.00312     17     0.698  0.860 0.0459
5 0.00250     18     0.695  0.863 0.0460</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">c</span>(<span class="st">". . ."</span>, <span class="fu">capture.output</span>(<span class="fu">printcp</span>(mifem.rpart, <span class="at">digits=</span><span class="dv">3</span>))[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)]), </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>. . .
Root node error: 321/1295 = 0.248

n= 1295 

       CP nsplit rel error xerror   xstd
1 0.20249      0     1.000  1.000 0.0484
2 0.00561      1     0.798  0.829 0.0453
3 0.00467     13     0.717  0.875 0.0462
4 0.00312     17     0.698  0.860 0.0459
5 0.00250     18     0.695  0.863 0.0460</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-w="7" data-h="2.75" data-bot="1" data-top="1.5" data-left="1.5" data-rt="1.5" data-mfrow="[1,2]" data-mgp="[2.5,0.5,0]" data-lwd="0.75">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(mifem.rpart, <span class="at">fg=</span><span class="st">"gray"</span>, <span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>mifemb.rpart <span class="ot">&lt;-</span> <span class="fu">prune</span>(mifem.rpart, <span class="at">cp=</span><span class="fl">0.01</span>)  <span class="do">## Prune tree back to 2 leaves</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(mifemb.rpart, <span class="at">under=</span><span class="cn">TRUE</span>, <span class="at">type=</span><span class="dv">4</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">box.palette=</span><span class="dv">0</span>, <span class="at">tweak=</span><span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-8.3.2-the-one-standard-deviation-rule" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.3.2-the-one-standard-deviation-rule">Subsection 8.3.2: The one-standard-deviation rule</h4>
</section>
<section id="subsection-8.3.3-printed-information-on-each-split" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.3.3-printed-information-on-each-split">Subsection 8.3.3: Printed Information on Each Split</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mifemb.rpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 1295 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 1295 321 live (0.7521 0.2479)  
  2) angina=y,n 1196 239 live (0.8002 0.1998) *
  3) angina=nk 99  17 dead (0.1717 0.8283) *</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">59</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>spam7a.rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> yesno <span class="sc">~</span> crl.tot <span class="sc">+</span> dollar <span class="sc">+</span> bang <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                      money <span class="sc">+</span> n000 <span class="sc">+</span> make, <span class="at">method=</span><span class="st">"class"</span>, <span class="at">cp =</span> <span class="fl">0.002</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">model=</span><span class="cn">TRUE</span>, <span class="at">data =</span> DAAG<span class="sc">::</span>spam7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(spam7a.rpart, <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
rpart(formula = yesno ~ crl.tot + dollar + bang + money + n000 + 
    make, data = DAAG::spam7, method = "class", model = TRUE, 
    cp = 0.002)

Variables actually used in tree construction:
[1] bang    crl.tot dollar  money   n000   

Root node error: 1813/4601 = 0.394

n= 4601 

        CP nsplit rel error xerror   xstd
1  0.47656      0     1.000  1.000 0.0183
2  0.07557      1     0.523  0.550 0.0154
3  0.01158      3     0.372  0.390 0.0135
4  0.01048      4     0.361  0.386 0.0134
5  0.00634      5     0.350  0.374 0.0133
6  0.00552     10     0.317  0.360 0.0130
7  0.00441     11     0.311  0.357 0.0130
8  0.00386     12     0.307  0.352 0.0129
9  0.00276     16     0.291  0.339 0.0127
10 0.00221     17     0.288  0.339 0.0127
11 0.00200     18     0.286  0.336 0.0127</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>cpdf <span class="ot">&lt;-</span> <span class="fu">signif</span>(<span class="fu">as.data.frame</span>(spam7a.rpart<span class="sc">$</span>cptable),<span class="dv">3</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>minRow <span class="ot">&lt;-</span> <span class="fu">which.min</span>(cpdf[,<span class="st">"xerror"</span>])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>upr <span class="ot">&lt;-</span> <span class="fu">sum</span>(cpdf[minRow, <span class="fu">c</span>(<span class="st">"xerror"</span>,<span class="st">"xstd"</span>)])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>takeRow <span class="ot">&lt;-</span> <span class="fu">min</span>((<span class="dv">1</span><span class="sc">:</span>minRow)[cpdf[<span class="dv">1</span><span class="sc">:</span>minRow,<span class="st">"xerror"</span>]<span class="sc">&lt;</span>upr])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>newNsplit <span class="ot">&lt;-</span> cpdf[takeRow, <span class="st">'nsplit'</span>]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>cpval <span class="ot">&lt;-</span> <span class="fu">mean</span>(cpdf[<span class="fu">c</span>(takeRow<span class="dv">-1</span>,takeRow),<span class="st">"CP"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-w="4.25" data-h="2.25" data-bot="-1" data-left="-1" data-top="1" data-right="-1" data-mgp="[2,0.5,0]" data-lwd="0.75">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>spam7b.rpart <span class="ot">&lt;-</span> <span class="fu">prune</span>(spam7a.rpart, <span class="at">cp=</span>cpval)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>rpart.plot<span class="sc">::</span><span class="fu">rpart.plot</span>(spam7b.rpart, <span class="at">under=</span><span class="cn">TRUE</span>, <span class="at">box.palette=</span><span class="st">"Grays"</span>, <span class="at">tweak=</span><span class="fl">1.65</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="how-does-the-one-standard-error-rule-affect-accuracy-of-estimates" class="level5">
<h5 class="anchored" data-anchor-id="how-does-the-one-standard-error-rule-affect-accuracy-of-estimates">How does the one standard error rule affect accuracy of estimates?</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">'randomForest'</span>, <span class="at">quietly=</span><span class="cn">TRUE</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>DAAG<span class="sc">::</span><span class="fu">compareTreecalcs</span>(<span class="at">data=</span>DAAG<span class="sc">::</span>spam7, <span class="at">fun=</span><span class="st">"rpart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> rpSEcvI    rpcvI rpSEtest   rptest  nSErule   nREmin 
  0.1396   0.1387   0.1269   0.1217   7.0000   8.0000 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>acctree.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">100</span>, <span class="at">ncol=</span><span class="dv">6</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>spam7 <span class="ot">&lt;-</span> DAAG<span class="sc">::</span>spam7</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>acctree.mat[i,] <span class="ot">&lt;-</span> DAAG<span class="sc">::</span><span class="fu">compareTreecalcs</span>(<span class="at">data=</span>spam7, <span class="at">fun=</span><span class="st">"rpart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-is-the-standard-error-calculated" class="level5">
<h5 class="anchored" data-anchor-id="how-is-the-standard-error-calculated">How is the standard error calculated?</h5>
</section>
<section id="when-are-tree-based-methods-appropriate-1" class="level5">
<h5 class="anchored" data-anchor-id="when-are-tree-based-methods-appropriate-1">When are tree-based methods appropriate?</h5>
</section>
</section>
</section>
<section id="section-8.4-from-one-tree-to-a-forest-a-more-global-optimality" class="level3">
<h3 class="anchored" data-anchor-id="section-8.4-from-one-tree-to-a-forest-a-more-global-optimality">Section 8.4: From one tree to a forest – a more global optimality</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(randomForest))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>spam7.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(yesno <span class="sc">~</span> ., <span class="at">data=</span>spam7, <span class="at">importance=</span><span class="cn">TRUE</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>spam7.rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = yesno ~ ., data = spam7, importance = TRUE) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 2

        OOB estimate of  error rate: 11.56%
Confusion matrix:
     n    y class.error
n 2651  137     0.04914
y  395 1418     0.21787</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">tuneRF</span>(<span class="at">x=</span>spam7[, <span class="sc">-</span><span class="dv">7</span>], <span class="at">y=</span>spam7<span class="sc">$</span>yesno, <span class="at">plot=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mtry = 2  OOB error = 11.8% 
Searching left ...
mtry = 1    OOB error = 12.67% 
-0.07366 0.05 
Searching right ...
mtry = 4    OOB error = 11.76% 
0.003683 0.05 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>zdash <span class="ot">&lt;-</span> <span class="fu">t</span>(z[,<span class="dv">2</span>,<span class="at">drop=</span>F])</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(zdash) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">"mtry="</span>,<span class="fu">rep</span>(<span class="st">""</span>,<span class="dv">2</span>)), z[,<span class="dv">1</span>])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(zdash,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         mtry=1     2     4
OOBError  0.127 0.118 0.118</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(spam7.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            n      y MeanDecreaseAccuracy MeanDecreaseGini
crl.tot 46.73  54.19                70.57           248.10
dollar  56.21  55.35                76.13           431.75
bang    91.66 100.46               115.95           588.53
money   33.09  51.87                53.49           206.51
n000    58.25  15.74                62.29           115.46
make    13.67  21.76                26.72            41.13</code></pre>
</div>
</div>
<section id="subsection-8.4.1-prior-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.4.1-prior-probabilities">Subsection 8.4.1: Prior probabilities</h4>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>Pima.tr <span class="ot">&lt;-</span> MASS<span class="sc">::</span>Pima.tr</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(Pima.tr<span class="sc">$</span>type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 No Yes 
132  68 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">41</span>)     <span class="co"># This seed should reproduce the result given here</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>Pima.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>Pima.tr)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The above is equivalent to:</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Pima.rf &lt;- randomForest(type ~ ., data=Pima.tr, sampsize=200)</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(Pima.rf<span class="sc">$</span>confusion,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     No Yes class.error
No  110  22       0.167
Yes  32  36       0.471</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(Pima.tr<span class="sc">$</span>type))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Pima.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>Pima.tr, <span class="at">sampsize=</span><span class="fu">c</span>(<span class="dv">68</span>,<span class="dv">68</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>Pima.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(type <span class="sc">~</span> ., <span class="at">data=</span>Pima.tr, <span class="at">sampsize=</span><span class="fu">c</span>(<span class="dv">132</span>,<span class="dv">68</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsection-8.4.2-a-low-dimensional-representation-of-observations" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.4.2-a-low-dimensional-representation-of-observations">Subsection 8.4.2: A low-dimensional representation of observations</h4>
</section>
<section id="subsection-8.4.3-models-with-a-complex-error-structure" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.4.3-models-with-a-complex-error-structure">Subsection 8.4.3: Models with a complex error structure</h4>
</section>
</section>
<section id="section-8.5-additional-notes-one-tree-or-many-trees" class="level3">
<h3 class="anchored" data-anchor-id="section-8.5-additional-notes-one-tree-or-many-trees">Section 8.5: Additional notes – one tree, or many trees?</h3>
<section id="subsection-8.5.1-differences-between-rpart-and-randomforest" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.5.1-differences-between-rpart-and-randomforest">Subsection 8.5.1: Differences between rpart() and randomForest()</h4>
<section id="error-rates-rpart-versus-randomforest" class="level5">
<h5 class="anchored" data-anchor-id="error-rates-rpart-versus-randomforest">Error rates – rpart() versus randomForest()</h5>
<div class="cell" data-layout-align="center" data-w="6.5" data-h="3" data-bot="0.5" data-left="-0.5" data-top="1" data-cex.lab="0.9" data-mgp="[2,0.25,0]" data-mfrow="[1,2]">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/g8_9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Accuracy comparisons</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>acctree.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">100</span>, <span class="at">ncol=</span><span class="dv">8</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acctree.mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rpSEcvI"</span>, <span class="st">"rpcvI"</span>, <span class="st">"rpSEtest"</span>, <span class="st">"rptest"</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"n.SErule"</span>, <span class="st">"nre.min.12"</span>, <span class="st">"rfOOBI"</span>, <span class="st">"rftest"</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)acctree.mat[i,] <span class="ot">&lt;-</span> DAAG<span class="sc">::</span><span class="fu">compareTreecalcs</span>(<span class="at">data=</span>spam7, <span class="at">cp=</span><span class="fl">0.0004</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">fun=</span><span class="fu">c</span>(<span class="st">"rpart"</span>, <span class="st">"randomForest"</span>))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>acctree.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(acctree.mat)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>lims <span class="ot">&lt;-</span> <span class="fu">range</span>(acctree.mat[, <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">7</span>,<span class="dv">8</span>)], <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>cthrublack <span class="ot">&lt;-</span> <span class="fu">adjustcolor</span>(<span class="st">"black"</span>, <span class="at">alpha.f=</span><span class="fl">0.75</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rfOOBI <span class="sc">~</span> rftest, <span class="at">data=</span>acctree.df, <span class="at">xlab=</span><span class="st">"Error rate - subset II"</span>, <span class="at">xlim=</span>lims,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span>lims, <span class="at">ylab=</span><span class="st">"OOB Error - fit to subset I"</span>, <span class="at">col=</span>cthrublack, <span class="at">fg=</span><span class="st">"gray"</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="fl">0.5</span>, <span class="st">"A"</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rptest <span class="sc">~</span> rftest, <span class="at">data=</span>acctree.df, <span class="at">xlab=</span><span class="st">"Error rate - subset II"</span>,</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"rpart Error rate, subset II"</span>, <span class="at">xlim=</span>lims, <span class="at">ylim=</span>lims,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span>cthrublack, <span class="at">fg=</span><span class="st">"gray"</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="fl">0.5</span>, <span class="st">"B"</span>, <span class="at">adj=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>acctree.mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">100</span>, <span class="at">ncol=</span><span class="dv">8</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acctree.mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rpSEcvI"</span>, <span class="st">"rpcvI"</span>, <span class="st">"rpSEtest"</span>, <span class="st">"rptest"</span>,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"n.SErule"</span>, <span class="st">"nre.min.12"</span>, <span class="st">"rfcvI"</span>, <span class="st">"rftest"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)acctree.mat[i,] <span class="ot">&lt;-</span> DAAG<span class="sc">::</span><span class="fu">compareTreecalcs</span>(<span class="at">data=</span>spam7,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">fun=</span><span class="fu">c</span>(<span class="st">"rpart"</span>, <span class="st">"randomForest"</span>))</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel A: Plot `rfOOBI` against `rftest`</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel B: Plot `rptest` against `rftest`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="times-required-for-computation" class="level5">
<h5 class="anchored" data-anchor-id="times-required-for-computation">Times required for computation</h5>
</section>
</section>
<section id="subsection-8.5.2-tree-based-methods-versus-other-approaches" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.5.2-tree-based-methods-versus-other-approaches">Subsection 8.5.2: Tree-based methods, versus other approaches</h4>
<section id="tree-based-methods-may-usefully-complement-other-approaches" class="level5">
<h5 class="anchored" data-anchor-id="tree-based-methods-may-usefully-complement-other-approaches">Tree-based methods may usefully complement other approaches</h5>
</section>
</section>
<section id="subsection-8.5.3-further-notes" class="level4">
<h4 class="anchored" data-anchor-id="subsection-8.5.3-further-notes">Subsection 8.5.3: Further notes</h4>
<section id="pruning-as-variable-selection" class="level5">
<h5 class="anchored" data-anchor-id="pruning-as-variable-selection">Pruning as variable selection</h5>
</section>
</section>
</section>
<section id="section-8.6-further-reading-and-extensions" class="level3">
<h3 class="anchored" data-anchor-id="section-8.6-further-reading-and-extensions">Section 8.6: Further reading and extensions</h3>
</section>
<section id="exercises-8.7" class="level3">
<h3 class="anchored" data-anchor-id="exercises-8.7">Exercises (8.7)</h3>
<p>8.5</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(MASS<span class="sc">::</span>biopsy, <span class="cf">function</span>(x)<span class="fu">sum</span>(<span class="fu">is.na</span>(x)))   <span class="do">## Will omit rows with NAs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ID    V1    V2    V3    V4    V5    V6    V7    V8    V9 class 
    0     0     0     0     0     0    16     0     0     0     0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>biops <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(MASS<span class="sc">::</span>biopsy)[,<span class="sc">-</span><span class="dv">1</span>]               <span class="do">## Omit also column 1 (IDs)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Examine list element names in randomForest object</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">randomForest</span>(class <span class="sc">~</span> ., <span class="at">data=</span>biops))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "call"            "type"            "predicted"      
 [4] "err.rate"        "confusion"       "votes"          
 [7] "oob.times"       "classes"         "importance"     
[10] "importanceSD"    "localImportance" "proximity"      
[13] "ntree"           "mtry"            "forest"         
[16] "y"               "test"            "inbag"          
[19] "terms"          </code></pre>
</div>
</div>
<p>8.5a</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Repeated runs, note variation in OOB accuracy.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  biops.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(class <span class="sc">~</span> ., <span class="at">data=</span>biops)  </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  OOBerr <span class="ot">&lt;-</span> <span class="fu">mean</span>(biops.rf<span class="sc">$</span>err.rate[,<span class="st">"OOB"</span>])</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(i, <span class="st">": "</span>, <span class="fu">round</span>(OOBerr, <span class="dv">4</span>), <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">round</span>(biops.rf<span class="sc">$</span>confusion,<span class="dv">4</span>))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1: 0.0288"
          benign malignant class.error
benign       432        12      0.0270
malignant      7       232      0.0293
[1] "2: 0.0344"
          benign malignant class.error
benign       431        13      0.0293
malignant      9       230      0.0377
[1] "3: 0.0308"
          benign malignant class.error
benign       433        11      0.0248
malignant      9       230      0.0377
[1] "4: 0.0307"
          benign malignant class.error
benign       431        13      0.0293
malignant      6       233      0.0251
[1] "5: 0.0311"
          benign malignant class.error
benign       433        11      0.0248
malignant      8       231      0.0335
[1] "6: 0.0301"
          benign malignant class.error
benign       431        13      0.0293
malignant      6       233      0.0251
[1] "7: 0.0312"
          benign malignant class.error
benign       433        11      0.0248
malignant      7       232      0.0293
[1] "8: 0.0301"
          benign malignant class.error
benign       433        11      0.0248
malignant      8       231      0.0335
[1] "9: 0.0285"
          benign malignant class.error
benign       433        11      0.0248
malignant      6       233      0.0251
[1] "10: 0.0301"
          benign malignant class.error
benign       432        12      0.0270
malignant      7       232      0.0293</code></pre>
</div>
</div>
<p>8.5b</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Repeated train/test splits: OOB accuracy vs test set accuracy.</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  trRows <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(biops)[<span class="dv">1</span>], <span class="at">size=</span><span class="fu">round</span>(<span class="fu">dim</span>(biops)[<span class="dv">1</span>]<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  biops.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(class <span class="sc">~</span> ., <span class="at">data=</span>biops[trRows, ],</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">xtest=</span>biops[<span class="sc">-</span>trRows,<span class="sc">-</span><span class="dv">10</span>], <span class="at">ytest=</span>biops[<span class="sc">-</span>trRows,<span class="dv">10</span>])</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  oobErr <span class="ot">&lt;-</span> <span class="fu">mean</span>(biops.rf<span class="sc">$</span>err.rate[,<span class="st">"OOB"</span>])</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  testErr <span class="ot">&lt;-</span> <span class="fu">mean</span>(biops.rf<span class="sc">$</span>test<span class="sc">$</span>err.rate[,<span class="st">"Test"</span>])</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(<span class="fu">c</span>(oobErr,testErr),<span class="dv">4</span>))</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0282 0.0340
[1] 0.0366 0.0327
[1] 0.0360 0.0226
[1] 0.0330 0.0311
[1] 0.0360 0.0384
[1] 0.0357 0.0353
[1] 0.0248 0.0399
[1] 0.0442 0.0270
[1] 0.0407 0.0268
[1] 0.0347 0.0242</code></pre>
</div>
</div>
<p>8.5c</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">randomForest</span>(class <span class="sc">~</span> ., <span class="at">data=</span>biops, <span class="at">xtest=</span>biops[,<span class="sc">-</span><span class="dv">10</span>], <span class="at">ytest=</span>biops[,<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = class ~ ., data = biops, xtest = biops[,      -10], ytest = biops[, 10]) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 3

        OOB estimate of  error rate: 2.93%
Confusion matrix:
          benign malignant class.error
benign       433        11     0.02477
malignant      9       230     0.03766
                Test set error rate: 0%
Confusion matrix:
          benign malignant class.error
benign       444         0           0
malignant      0       239           0</code></pre>
</div>
</div>
<p>8.7</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Run model on total data</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">randomForest</span>(<span class="fu">as.factor</span>(type) <span class="sc">~</span> ., <span class="at">data=</span>Pima.tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = as.factor(type) ~ ., data = Pima.tr) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 2

        OOB estimate of  error rate: 28%
Confusion matrix:
     No Yes class.error
No  109  23      0.1742
Yes  33  35      0.4853</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>rowsamp <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">dim</span>(Pima.tr)[<span class="dv">1</span>], <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">randomForest</span>(<span class="fu">as.factor</span>(type) <span class="sc">~</span> ., <span class="at">data=</span>Pima.tr[rowsamp, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = as.factor(type) ~ ., data = Pima.tr[rowsamp,      ]) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 2

        OOB estimate of  error rate: 8.5%
Confusion matrix:
     No Yes class.error
No  129   3     0.02273
Yes  14  54     0.20588</code></pre>
</div>
</div>
<p>8.8a</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>d500 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span>diamonds[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ggplot2<span class="sc">::</span>diamonds), <span class="dv">500</span>),]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(<span class="fu">sapply</span>(d500, class))  <span class="co"># Check the class of the 10 columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    carat      cut1      cut2    color1    color2  clarity1  clarity2 
"numeric" "ordered"  "factor" "ordered"  "factor" "ordered"  "factor" 
    depth     table     price         x         y         z 
"numeric" "numeric" "integer" "numeric" "numeric" "numeric" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">spm</span>(d500)       <span class="co"># If screen space is limited do two plots, thus:</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) variables 1 to 5 and 7 (`price`); 2) variables 6 to 10</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(d500[, <span class="st">"price"</span>, <span class="at">drop =</span> T]))         <span class="co"># Distribution is highly skew</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>MASS<span class="sc">::</span><span class="fu">boxcox</span>(price<span class="sc">~</span>., <span class="at">data=</span>ggplot2<span class="sc">::</span>diamonds)  <span class="co"># Suggests log transformation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gH7f-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gH7f-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gH7f-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="htbp"></p>
</figure>
</div>
</div>
</div>
<p>8.8b</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>diamonds <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span>diamonds; Y <span class="ot">&lt;-</span> diamonds[,<span class="st">"price"</span>, drop<span class="ot">=</span>T]</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>d7.rpart <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="fu">log</span>(Y) <span class="sc">~</span> ., <span class="at">data=</span>diamonds[,<span class="sc">-</span><span class="dv">7</span>], <span class="at">cp=</span><span class="fl">5e-7</span>) <span class="co"># Complex tree</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>d.rpart <span class="ot">&lt;-</span> <span class="fu">prune</span>(d7.rpart, <span class="at">cp=</span><span class="fl">0.0025</span>)            </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(d.rpart)   <span class="co"># Relative to `d7.rpart`, simpler and less accurate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
rpart(formula = log(Y) ~ ., data = diamonds[, -7], cp = 0.0000005)

Variables actually used in tree construction:
[1] carat   clarity color   x       y      

Root node error: 55531/53940 = 1

n= 53940 

       CP nsplit rel error xerror    xstd
1  0.7244      0     1.000  1.000 0.00409
2  0.0885      1     0.276  0.276 0.00141
3  0.0661      2     0.187  0.188 0.00104
4  0.0290      3     0.121  0.121 0.00075
5  0.0105      4     0.092  0.092 0.00059
6  0.0072      5     0.082  0.082 0.00054
7  0.0071      6     0.074  0.072 0.00049
8  0.0030      7     0.067  0.068 0.00047
9  0.0026      8     0.064  0.065 0.00046
10 0.0026      9     0.062  0.061 0.00044
11 0.0025     10     0.059  0.059 0.00044</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>nmin <span class="ot">&lt;-</span> <span class="fu">which.min</span>(d7.rpart<span class="sc">$</span>cptable[,<span class="st">'xerror'</span>])</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>dOpt.rpart <span class="ot">&lt;-</span> <span class="fu">prune</span>(d7.rpart, <span class="at">cp=</span>d7.rpart<span class="sc">$</span>cptable[nmin,<span class="st">'CP'</span>])</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dOpt.rpart<span class="sc">$</span>cptable[nmin])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0000008743</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(xerror12 <span class="ot">&lt;-</span> dOpt.rpart<span class="sc">$</span>cptable[<span class="fu">c</span>(<span class="fu">nrow</span>(d.rpart<span class="sc">$</span>cptable),nmin), <span class="st">"xerror"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     11    1931 
0.05934 0.01074 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a> <span class="do">## Subtract from 1.0 to obtain R-squared statistics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="st">"d.rpart"</span><span class="ot">=</span>d.rpart[[<span class="st">'variable.importance'</span>]],</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">"dOpt.rpart"</span><span class="ot">=</span>dOpt.rpart[[<span class="st">'variable.importance'</span>]]) <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  (\(x)<span class="dv">100</span><span class="sc">*</span><span class="fu">apply</span>(x,<span class="dv">1</span>,<span class="cf">function</span>(x)x<span class="sc">/</span><span class="fu">sum</span>(x)))() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              y    x carat    z clarity table color depth cut
d.rpart    23.8 23.1  22.9 22.4     4.8   2.8   0.2   0.1 0.1
dOpt.rpart 23.5 22.9  22.7 22.2     5.2   2.7   0.5   0.2 0.1</code></pre>
</div>
</div>
<p>8.9</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span>diamonds[,<span class="st">"price"</span>, drop<span class="ot">=</span>T]</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>samp5K <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(diamonds), <span class="at">size=</span><span class="dv">5000</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>(diamond5K.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">x=</span>diamonds[samp5K,<span class="sc">-</span><span class="dv">7</span>], <span class="at">y=</span><span class="fu">log</span>(Y[samp5K]),</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">xtest=</span>diamonds[<span class="sc">-</span>samp5K,<span class="sc">-</span><span class="dv">7</span>], <span class="at">ytest=</span><span class="fu">log</span>(Y[<span class="sc">-</span>samp5K])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(x = diamonds[samp5K, -7], y = log(Y[samp5K]), xtest = diamonds[-samp5K,      -7], ytest = log(Y[-samp5K])) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 3

          Mean of squared residuals: 0.01434
                    % Var explained: 98.59
                       Test set MSE: 0.01
                    % Var explained: 98.65</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Omit arguments `xtest` and `ytest` if calculations take too long</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(<span class="fu">importance</span>(diamond5K.rf)[,<span class="dv">1</span>], <span class="at">decreasing=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  (\(x)<span class="dv">100</span><span class="sc">*</span>x<span class="sc">/</span><span class="fu">sum</span>(x))() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        y carat  x    z clarity color depth table cut
[1,] 33.5  23.6 21 17.2     2.6   1.2   0.4   0.3 0.2</code></pre>
</div>
</div>
<p>8.9a</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>(diamond5KU.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">x=</span>diamonds[samp5K,<span class="sc">-</span><span class="dv">7</span>], <span class="at">y=</span>Y[samp5K],</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">xtest=</span>diamonds[<span class="sc">-</span>samp5K,<span class="sc">-</span><span class="dv">7</span>], <span class="at">ytest=</span>Y[<span class="sc">-</span>samp5K]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(x = diamonds[samp5K, -7], y = Y[samp5K], xtest = diamonds[-samp5K,      -7], ytest = Y[-samp5K]) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 3

          Mean of squared residuals: 450742
                    % Var explained: 97.11
                       Test set MSE: 493916
                    % Var explained: 96.9</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="st">"/Users/johnm1/pkgs/PGRcode/inst/doc/"</span>)){</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>code <span class="ot">&lt;-</span> knitr<span class="sc">::</span>knit_code<span class="sc">$</span><span class="fu">get</span>()</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>txt <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">## "</span>, <span class="fu">names</span>(code),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">sapply</span>(code, paste, <span class="at">collapse=</span><span class="st">'</span><span class="sc">\n</span><span class="st">'</span>))</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(txt, <span class="at">con=</span><span class="st">"/Users/johnm1/pkgs/PGRcode/inst/doc/ch8.R"</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./ch7.html" class="pagination-link  aria-label=" &lt;span="" 7:="" multilevel="" models,="" and="" repeated="" measures&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Chapter 7: Multilevel models, and repeated measures</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch9.html" class="pagination-link" aria-label="<span class='chapter-number'>9</span>&nbsp; <span class='chapter-title'>Chapter 9: Multivariate data exploration and discrimination</span>">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Chapter 9: Multivariate data exploration and discrimination</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>